pipeline {
    agent {
        kubernetes {
            yamlFile 'pod.yaml'
        }
    }
    environment {
        // Define environment variables if needed
        DOCKER_REGISTRY = 'eladjerbi'
        IMAGE_NAME = 'weather'
        KUBE_NAMESPACE = 'testing'
        GITOPS_REPO = 'https://github.com/EladJerbi/gitops-weather.git'
    }
    stages {
        stage('Build with Kaniko for Main branch') {
            when {
                expression {
                    // Execute this stage only if the branch is 'main'
                    return env.GIT_BRANCH == 'origin/main'
                }
            }
            steps {
                container(name: 'kaniko', shell: '/busybox/sh') {
                    sh '''
                    echo "Branch Name: ${env.GIT_BRANCH}"
                    echo "Create a new version for the Docker image."
                    ./version.sh

                    echo "Building Docker image for the main branch, IMAGE_TAG created fron version.sh script"
                    /kaniko/executor --context `pwd` --cache=true --cache-dir=/workspace/cache --destination $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
                    '''
                }
            }
        }
        stage('Build with Kaniko for feature branches') {
            when {
                expression {
                    // Execute this stage for any branch other than 'main'
                    return env.GIT_BRANCH != 'origin/main'
                }
            }
            steps {
                container(name: 'kaniko', shell: '/busybox/sh') {
                    script {
                        def imageTag = "${BUILD_NUMBER}-${GIT_COMMIT}"
                        echo "Branch Name: ${env.GIT_BRANCH}"
                        echo "Image imageTag : ${imageTag}"
                        echo "Building Docker image for ${env.GIT_BRANCH} branch"
                        sh "/kaniko/executor --context `pwd` --destination $DOCKER_REGISTRY/${IMAGE_NAME}-testing:$imageTag"
                    }
                }
            }
        }
        stage('Deploy') {
            when {
                expression {
                    // Execute this stage for any branch
                    return true
                }
            }
            steps {
                container('kubectl') {
                    sh 'echo "Deploying to Kubernetes cluster"'
                    script {
                        if (env.GIT_BRANCH == 'origin/main') {
                            sh "argocd app set weather-app --repo $GITOPS_REPO --path . --dest-namespace $KUBE_NAMESPACE"
                            sh "argocd app sync weather-app"
                        } else {
                            def imageName = "${IMAGE_NAME}:${BUILD_NUMBER}-${GIT_COMMIT}"
                            sh "kubectl run $imageName --image=eladjerbi/$imageName-testing -n testing"
                        }
                    }
                }
            }
        }
    }
}


